modulex.add("scroll-view/touch",["anim/timer","component/container","component/extension/content-box","node","feature","util","event-dom/gesture/basic","event-dom/gesture/pan"],function(t,e,l){var o,n,r=t("anim/timer"),i=t("component/container"),a=t("component/extension/content-box"),s=t("node"),c=t("feature"),f=t("util"),u=t("event-dom/gesture/basic"),p=t("event-dom/gesture/pan");o=function(t){function e(){var t=this,e=t.el,l=e.scrollTop,o=e.scrollLeft;l&&t.set("scrollTop",l+t.get("scrollTop")),o&&t.set("scrollLeft",o+t.get("scrollLeft")),e.scrollTop=e.scrollLeft=0}function l(t,e){t.scrollView.set(e.prop,e.val)}function o(t,e){var l,o=this,n=o.$contentEl,r=t.scrollHeight,i=t.scrollWidth,a=t.clientHeight,s=t.clientWidth,c=e&&e.prevVal||{};if(c.scrollHeight!==r||c.scrollWidth!==i||a!==c.clientHeight||s!==c.clientWidth){o.scrollHeight=r,o.scrollWidth=i,o.clientHeight=a,o.clientWidth=s,l=o.allowScroll={},r>a&&(l.top=1),i>s&&(l.left=1),o.minScroll={left:0,top:0};var f,u;o.maxScroll={left:f=i-s,top:u=r-a},delete o.scrollStep;var p=o.get("snap"),g=o.get("scrollLeft"),h=o.get("scrollTop");if(p){var d=n.offset(),v=o.pages="string"==typeof p?n.all(p):n.children(),m=o.get("pageIndex"),S=o.pagesOffset=[];if(v.each(function(t,e){var l=t.offset(),o=l.left-d.left,n=l.top-d.top;f>=o&&u>=n&&(S[e]={left:o,top:n,index:e})}),m)return o.scrollToPage(m),void 0}o.scrollToWithBounds({left:g,top:h}),o.fire("reflow",t)}}var n,u=r,p=i,g=a,h=s,d=h.Event.KeyCode,v=c,m=v.getCssVendorInfo("transform"),S=Math.floor,T=v.isTransform3dSupported(),x=!!m,X=f,_={initializer:function(){this.scrollAnims=[]},bindUI:function(){var t=this,l=t.$el;l.on("mousewheel",t.handleMouseWheel,t).on("scroll",e,t)},syncUI:function(){this.sync()},sync:function(){var t=this,e=t.el,l=t.contentEl,o=Math.max(l.offsetHeight,l.scrollHeight),n=Math.max(l.offsetWidth,l.scrollWidth),r=e.clientHeight,i=e.clientWidth;t.set("dimension",{scrollHeight:o,scrollWidth:n,clientWidth:i,clientHeight:r})},_onSetDimension:o,handleKeyDownInternal:function(t){var e=t.target,l=h(e),o=l.nodeName();if("input"===o||"textarea"===o||"select"===o||l.hasAttr("contenteditable"))return void 0;var n,r=this,i=t.keyCode,a=r.getScrollStep(),s=r.allowScroll.left,c=r.allowScroll.top;if(c){var f=a.top,u=r.clientHeight,p=r.get("scrollTop");i===d.DOWN?(r.scrollToWithBounds({top:p+f}),n=!0):i===d.UP?(r.scrollToWithBounds({top:p-f}),n=!0):i===d.PAGE_DOWN?(r.scrollToWithBounds({top:p+u}),n=!0):i===d.PAGE_UP&&(r.scrollToWithBounds({top:p-u}),n=!0)}if(s){var g=a.left,v=r.get("scrollLeft");i===d.RIGHT?(r.scrollToWithBounds({left:v+g}),n=!0):i===d.LEFT&&(r.scrollToWithBounds({left:v-g}),n=!0)}return n},getScrollStep:function(){var t=this;if(t.scrollStep)return t.scrollStep;var e=h(this.get("el")[0].ownerDocument),l=t.clientHeight,o=t.clientWidth;return t.scrollStep={top:Math.max(l*l*.7/e.height(),20),left:Math.max(o*o*.7/e.width(),20)},t.scrollStep},handleMouseWheel:function(t){if(!this.get("disabled")){var e,l,o,n,r=this,i=r.getScrollStep(),a=r.maxScroll,s=r.minScroll;if((o=t.deltaY)&&r.allowScroll.top){var c=r.get("scrollTop");e=a.top,l=s.top,l>=c&&o>0||c>=e&&0>o||(r.scrollToWithBounds({top:c-t.deltaY*i.top}),t.preventDefault())}if((n=t.deltaX)&&r.allowScroll.left){var f=r.get("scrollLeft");e=a.left,l=s.left,l>=f&&n>0||f>=e&&0>n||(r.scrollToWithBounds({left:f-t.deltaX*i.left}),t.preventDefault())}}},stopAnimation:function(){var t=this;t.scrollAnims.length&&(X.each(t.scrollAnims,function(t){t.stop()}),t.scrollAnims=[]),t.scrollToWithBounds({left:t.get("scrollLeft"),top:t.get("scrollTop")})},_uiSetPageIndex:function(t){this.scrollToPage(t)},getPageIndexFromXY:function(t,e,l){var o,n,r=this.pagesOffset.concat([]),i=e?"left":"top";if(r.sort(function(t,e){return t[i]-e[i]}),l>0){for(o=0;o<r.length;o++)if(n=r[o],n[i]>=t)return n.index}else for(o=r.length-1;o>=0;o--)if(n=r[o],n[i]<=t)return n.index;return void 0},scrollToPage:function(t,e){var l,o=this;(l=o.pagesOffset)&&l[t]&&(o.set("pageIndex",t),o.scrollTo(l[t],e))},scrollToWithBounds:function(t,e){var l=this,o=l.maxScroll,n=l.minScroll;t.left&&(t.left=Math.min(Math.max(t.left,n.left),o.left)),t.top&&(t.top=Math.min(Math.max(t.top,n.top),o.top)),l.scrollTo(t,e)},scrollTo:function(t,e){var o=this,n=t.left,r=t.top;if(e){var i={},a={};void 0!==n&&(a.scrollLeft=n,i.scrollLeft=o.get("scrollLeft")),void 0!==r&&(a.scrollTop=r,i.scrollTop=o.get("scrollTop")),e.frame=l,e.node=i,e.to=a;var s;o.scrollAnims.push(s=new u(e)),s.scrollView=o,s.run()}else void 0!==n&&o.set("scrollLeft",n),void 0!==r&&o.set("scrollTop",r)},_onSetScrollLeft:function(t){this.contentEl.style.left=-t+"px"},_onSetScrollTop:function(t){this.contentEl.style.top=-t+"px"}};return x&&(n=m.propertyName,_._onSetScrollLeft=function(t){this.contentEl.style[n]="translateX("+S(0-t)+"px) translateY("+S(0-this.get("scrollTop"))+"px)"+(T?" translateZ(0)":"")},_._onSetScrollTop=function(t){this.contentEl.style[n]="translateX("+S(0-this.get("scrollLeft"))+"px) translateY("+S(0-t)+"px)"+(T?" translateZ(0)":"")}),t=p.extend([g],_,{version:"1.0.1",ATTRS:{focusable:{value:!0},allowTextSelection:{value:!0},handleGestureEvents:{value:!1},scrollLeft:{render:1,value:0},scrollTop:{render:1,value:0},dimension:{},snap:{value:!1},pageIndex:{value:0}},xclass:"scroll-view"})}(),n=function(t){function e(t,e,o){if(!l(t,o)){var n,r="left"===o?e.deltaX:e.deltaY,i=t.startScroll[o]-r,a=t.minScroll,s=t.maxScroll;t._bounce||(i=Math.min(Math.max(i,a[o]),s[o])),i<a[o]?(n=a[o]-i,n*=x,i=a[o]-n):i>s[o]&&(n=i-s[o],n*=x,i=s[o]+n),t.set("scroll"+m.ucfirst(o),i)}}function l(t,e){var l="left"===e?"lockX":"lockY";return!t.allowScroll[e]&&t["_"+l]?1:0}function n(t,e,o,n){if(l(t,o))return n(),void 0;var r,a="scroll"+m.ucfirst(o),s=t.get(a),c=t.minScroll,f=t.maxScroll;if(s<c[o]?r=c[o]:s>f[o]&&(r=f[o]),void 0!==r){var u={};return u[o]=r,t.scrollTo(u,{duration:t.get("bounceDuration"),easing:t.get("bounceEasing"),queue:!1,complete:n}),void 0}if(t.pagesOffset)return n(),void 0;var p="left"===o?-e.velocityX:-e.velocityY;p=Math.min(Math.max(p,-X),X);var g={node:{},to:{},duration:9999,queue:!1,complete:n,frame:i(t,p,s,a,f[o],c[o])};g.node[o]=s,g.to[o]=null,t.scrollAnims.push(new T(g).run())}function i(t,e,l,o,n,r){var i=e*W,a=1,s=0;return function(e,c){var f,u,p=m.now();if(a){f=p-e.startTime;var g=Math.exp(f*A);if(u=parseInt(l+i*(1-g)/(0-b),10),u>r&&n>u)return c.lastValue===u?(c.pos=1,void 0):(c.lastValue=u,t.set(o,u),void 0);a=0,i*=g,l=r>=u?r:n,s=p}else{f=p-s;var h=f/W,d=h*Math.exp(0-E*h);u=parseInt(i*d,10),0===u&&(c.pos=1),t.set(o,l+u)}}}function a(t){var e=this;e.isScrolling&&e.pagesOffset||s.call(e,t)||(e.startScroll={},e.dragInitDirection=null,e.isScrolling=1,e.startScroll.left=e.get("scrollLeft"),e.startScroll.top=e.get("scrollTop"))}function s(t){var e=this;if("touch"!==t.gestureType)return!0;var l=e._lockX,o=e._lockY;if(l||o){var n=t.direction;if(l&&"left"===n&&!e.allowScroll[n])return e.isScrolling=0,e._preventDefaultX&&t.preventDefault(),!0;if(o&&"top"===n&&!e.allowScroll[n])return e.isScrolling=0,e._preventDefaultY&&t.preventDefault(),!0}t.preventDefault()}function c(t){var l=this;s.call(l,t)||(e(l,t,"left"),e(l,t,"top"),l.fire("touchMove"))}function g(t){var e=this;s.call(e,t)||e.fire("touchEnd",{pageX:t.pageX,deltaX:t.deltaX,deltaY:t.deltaY,pageY:t.pageY,velocityX:t.velocityX,velocityY:t.velocityY})}function h(t){function e(){if(o++,2===o){var e=function(){l.isScrolling=0,l.fire("scrollTouchEnd",{pageX:t.pageX,pageY:t.pageY,deltaX:-r,deltaY:-i,fromPageIndex:f,pageIndex:l.get("pageIndex")})};if(!l.pagesOffset)return e(),void 0;var n=l._snapDurationCfg,a=l._snapEasingCfg,f=l.get("pageIndex"),u=l.get("scrollLeft"),p=l.get("scrollTop"),g={duration:n,easing:a,complete:e},h=l.pagesOffset,d=h.length;if(l.isScrolling=0,s||c)if(s&&c){var v,m,S=[],T={left:u,top:p};for(v=0;d>v;v++){var x=h[v];x&&(r>0&&x.left>T.left?S.push(x):0>r&&x.left<T.left&&S.push(x))}var X,_,Y=S.length;if(i>0)for(X=Number.MAX_VALUE,v=0;Y>v;v++)_=S[v],_.top>T.top&&X<_.top-T.top&&(X=_.top-T.top,m=S.index);else for(X=Number.MAX_VALUE,v=0;Y>v;v++)_=S[v],_.top<T.top&&X<T.top-_.top&&(X=T.top-_.top,m=S.index);void 0!==m?m!==f?l.scrollToPage(m,g):(l.scrollToPage(m),e()):e()}else if(s||c){var D=l.getPageIndexFromXY(s?u:p,s,s?r:i);l.scrollToPage(D,g)}else l.scrollToPage(f),e()}}var l=this,o=0,r=-t.deltaX,i=-t.deltaY,a=l._snapThresholdCfg,s=l.allowScroll.left&&Math.abs(r)>a,c=l.allowScroll.top&&Math.abs(i)>a;n(l,t,"left",e),n(l,t,"top",e)}function d(t){var e=this;e.isScrolling&&"touch"===t.gestureType&&t.preventDefault(),e.isScrolling&&e.pagesOffset||e.isScrolling&&(e.stopAnimation(),e.fire("scrollTouchEnd",{pageX:t.pageX,pageY:t.pageY}))}function v(t){var e=t.get("disabled")?"detach":"on";t.$el[e](Y.PAN_START,a,t)[e](_.START,d,t)[e](Y.PAN,c,t)[e](Y.PAN_END,g,t)}var m=f,S=o,T=r,x=.5,X=6,_=u,Y=p,D=.5,W=20,b=Math.log(1-D/10),A=b/W,E=.3;return t=S.extend({initializer:function(){var t=this;t._preventDefaultY=t.get("preventDefaultY"),t._preventDefaultX=t.get("preventDefaultX"),t._lockX=t.get("lockX"),t._lockY=t.get("lockY"),t._bounce=t.get("bounce"),t._snapThresholdCfg=t.get("snapThreshold"),t._snapDurationCfg=t.get("snapDuration"),t._snapEasingCfg=t.get("snapEasing"),t.publish("touchEnd",{defaultFn:h,defaultTargetOnly:!0})},bindUI:function(){v(this)},_onSetDisabled:function(t){var e=this;e.callSuper(t),v(e)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper(),this.isScrolling=0}},{version:"1.0.1",ATTRS:{lockX:{value:!0},preventDefaultX:{value:!0},lockY:{value:!1},preventDefaultY:{value:!1},snapDuration:{value:.3},snapEasing:{value:"easeOut"},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:.4},bounceEasing:{value:"easeOut"}}})}(),l.exports=n});