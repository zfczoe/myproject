modulex.add("router",["event-dom","url","event-custom","feature"],function(t,e,r){var n,a,o,i,u=t("event-dom"),s=t("url"),c=t("event-custom"),l=t("feature");n=function(t){function e(t){return t.replace(/__ks-vid=.+$/,"")}function r(t){var e;return(e=t.match(/__ks-vid=(.+)$/))?parseInt(e[1],10):0}function n(t){var e=t.match(/#(.+)$/);return e&&e[1]||""}var a,o=u,i=Object.prototype.toString;return a={mix:function(t,e){for(var r in e)t[r]=e[r];return t},isArray:Array.isArray||function(t){return"[object Array]"===i.call(t)},urlDecode:function(t){return decodeURIComponent(t.replace(/\+/g," "))},startsWith:function(t,e){return 0===t.lastIndexOf(e,0)},endWithSlash:function(t){return"/"===t.charAt(t.length-1)},startWithSlash:function(t){return"/"===t.charAt(0)},removeEndSlash:function(t){return this.endWithSlash(t)&&(t=t.substring(0,t.length-1)),t},removeStartSlash:function(t){return this.startWithSlash(t)&&(t=t.substring(1)),t},addEndSlash:function(t){return this.removeEndSlash(t)+"/"},addStartSlash:function(t){return t?"/"+this.removeStartSlash(t):t},getFullPath:function(t,e){return location.protocol+"//"+location.host+this.removeEndSlash(e)+this.addStartSlash(t)},equalsIgnoreSlash:function(t,e){return t=this.removeEndSlash(t),e=this.removeEndSlash(e),t===e},getHash:function(t){return e(n(t).replace(/^!/,"")).replace(o.REPLACE_HISTORY,"")},removeVid:e,hasVid:function(t){return-1!==t.indexOf("__ks-vid=")},addVid:function(t,e){return t+"__ks-vid="+e},getVidFromUrlWithHash:function(t){return r(n(t))},getVidFromHash:r},t=a}(),a=function(t){function e(t,e,r,n){return a.isArray(t)&&(t="("+t.join("|")+")"),t=t.concat(r?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(t,r,n,a,o,i,u){return e.push(a),r=r||"",""+(i?"":r)+"(?:"+(i?r:"")+(n||"")+(o||n&&"([^/.]+?)"||"([^/]+?)")+")"+(i||"")+(u?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),{keys:e,regexp:new RegExp("^"+t+"$",n?"":"i")}}function r(t,r,n){var o=this;o.path=t,o.callbacks=r,o.keys=[],"string"==typeof t||a.isArray(t)?a.mix(o,e(t,o.keys,n.strict,n.caseSensitive)):o.regexp=t}var a=n;return r.prototype={match:function(t){var e=this,r=t.match(e.regexp);if(!r)return!1;for(var n=e.keys,o=[],i=1,u=r.length;u>i;++i){var s=n[i-1],c="string"==typeof r[i]?a.urlDecode(r[i]):r[i];s?o[s]=c:o.push(c)}return o},removeCallback:function(t){for(var e=this.callbacks||[],r=e.length-1;r>=0;r++)e===t&&e.splice(r,1)}},t=r}(),o=function(t){function e(t){for(var e in t)this[e]=t[e]}return e.prototype={param:function(t){var e=this;return t in e.params?e.params[t]:e.query[t]}},t=e}(),i=function(t){function e(t,e){var r=S.addVid("#!"+t+(w?"":e?k.REPLACE_HISTORY:""),q);e?location.replace(r):location.hash=r}function r(t){t=t||location.href;var e=R.parse(t);return!W.useHash&&_?e.pathname.substr(W.urlRoot.length)+(e.search||""):S.getHash(t)}function i(t,e,r){function n(){if(a++,a===o)r(t,e);else{var i=d[a];if(S.startsWith(t.path+"/",i[0]+"/")){var u=i[0].length;t.url=t.url.slice(u);var s=t.path;t.path=t.path.slice(u),i[1](t,n),t.url=t.originalUrl,t.path=s}else n()}}var a=-1,o=d.length;n()}function h(t,e){function r(){if(n++,n!==a){var o=m[n];if(t.params=o.match(t.path)){var i=-1,u=o.callbacks,s=u.length,c=function(n){"route"===n?(c=null,r()):(i++,i!==s&&(t.route=o,u[i](t,e,c)))};c("")}else r()}}var n=-1,a=m.length;r()}function f(e,n){var a=r(),o=R.parse(a,!0),u=o.query;o.search="",o.query={};var s=R.stringify(o)||"/",c=new b({query:u,backward:e===!0,replace:n===!0,forward:e===!1&&n===!1,path:s,url:a,originalUrl:a}),l={redirect:t.navigate};t.fire("dispatch",{request:c,response:l}),i(c,l,h)}function p(t){var e=!1,r=!1;t===I[I.length-2]?(e=!0,I.pop()):t!==I[I.length-1]?I.push(t):r=!0,f(e,r)}function v(t){var e=t.originalEvent.state;e&&p(e.vid)}function g(t){var e=t.newURL||location.href,r=H(e);r&&p(r)}t={};var d=[],m=[],S=n,y=a,R=s,b=o,k=u,E=c,H=S.getVidFromUrlWithHash,x=window,A=x.history,w=l.isHashChangeSupported(),_=!(!A||!A.pushState),V=100,q=10,I=[q],W={urlRoot:"",useHash:!_};S.mix(t,E.Target),t.use=function(t,e){"string"!=typeof t&&(e=t,t=""),d.push([t,e])},t.navigate=function(t,n){n=n||{};var a=n.replace||!1,o=r(),i=R.parse(o);"?"===t.charAt(0)&&(i.search=t,t=R.stringify(i)),o!==t?(a||(q++,I.push(q)),!W.useHash&&_?(A[a?"replaceState":"pushState"]({vid:q},"",S.getFullPath(t,W.urlRoot)),f(!1,a)):_?(A[a?"replaceState":"pushState"]({vid:q},"","#!"+t),f(!1,a)):e(t,a)):n&&n.triggerRoute&&f(!1,!0)},t.get=function(t){var e=[].slice.call(arguments,1);m.push(new y(t,e,W))},t.matchRoute=function(t){for(var e=0,r=m.length;r>e;e++)if(m[e].match(t))return m[e];return!1},t.removeRoute=function(t,e){for(var r=m.length-1;r>=0;r--){var n=m[r];n.path===t&&(e?(n.removeCallback(e),n.callbacks.length||m.splice(r,1)):m.splice(r,1))}},t.clearRoutes=function(){d=[],m=[]},t.hasRoute=function(t){for(var e=0,r=m.length;r>e;e++)if(m[e].path===t)return m[e];return!1},t.config=function(t){t.urlRoot&&(t.urlRoot=t.urlRoot.replace(/\/$/,"")),S.mix(W,t)};var U;return t.start=function(n){if(U)return n&&n.call(t);var a=W.useHash,o=W.urlRoot,i=W.triggerRoute,u=location.pathname,s=location.href,c=r(),l=location.hash.match(/#!.+/);if(!a)if(_){if(l)if(o)S.equalsIgnoreSlash(u,o)?(A.replaceState({},"",s=S.getFullPath(c,o)),i=1):console.error("router: location path must be same with urlRoot!");else{var h=location.hash.substring(2);"/"===h[0]&&(h=h.substring(1)),A.replaceState({},"",s=location.protocol+"//"+location.host+location.pathname+h),i=1}}else{if(!S.equalsIgnoreSlash(u,o))return location.replace(S.addEndSlash(o)+"#!"+c),void 0;a=!0}return setTimeout(function(){var o=_;_?k.on(x,"popstate",v):(k.on(x,"hashchange",g),i=1),a&&(r()?_||H(s)===q?_&&S.hasVid(s)&&location.replace(s=S.removeVid(s)):(e(S.getHash(s),!0),i=0):(t.navigate("/",{replace:!0}),i=0,o=!1)),o&&A.replaceState({vid:q},"",s),i&&f(!1,!0),n&&n(t)},V),U=!0,t},t.Utils=S,t.version="1.0.1",t.stop=function(){U=!1,k.detach(x,"hashchange",g),k.detach(x,"popstate",v)},t}(),r.exports=i});